<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroJournal Tracker</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font stack (Inter) and background */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        /* Custom scrollbar styling - Indigo Theme */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f46e5; }
        * { scrollbar-width: thin; scrollbar-color: #6366f1 #f1f5f9; }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
    </style>
    <!-- Load Chart.js for Mood Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen text-slate-800">

    <div id="app" class="max-w-3xl mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-2">
                    <span class="text-indigo-600">Micro</span>Journal
                    <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-full font-semibold tracking-wide">AI</span>
                </h1>
                <p class="text-slate-500 text-sm mt-1">Capture thoughts. Discover patterns.</p>
            </div>
            
            <!-- User Status / Auth -->
            <div id="auth-status" class="text-xs text-right">
                <span class="text-amber-600">Initializing...</span>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex bg-white p-1 rounded-xl shadow-sm border border-slate-200 mb-6" id="nav-tabs">
            <!-- Tabs will be dynamically rendered/controlled here -->
        </nav>

        <!-- Error & Success Toasts -->
        <div id="messages" class="mb-4">
            <!-- Messages (errors/success) will appear here -->
        </div>

        <!-- Main Content View -->
        <div id="main-content">
            <!-- Content will be rendered based on the current view ('write', 'history', 'insights', 'dashboard') -->
        </div>

    </div>

    <!-- Edit Modal Structure -->
    <div id="edit-modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 invisible" aria-hidden="true">
        <div class="bg-white rounded-2xl w-full max-w-xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Edit Journal Entry</h3>
            <textarea id="edit-text-area" rows="8" class="w-full p-4 border border-slate-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500/30 mb-4 text-slate-700"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="App.closeEditModal()" class="px-5 py-2 rounded-xl text-slate-600 border border-slate-300 hover:bg-slate-100 transition-colors">Cancel</button>
                <button onclick="App.handleUpdate()" id="update-button" class="px-5 py-2 rounded-xl font-semibold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors disabled:bg-indigo-300" disabled>
                    <i class="lucide lucide-save mr-2"></i> Save Changes
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase, Lucide Icons & App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            serverTimestamp,
            updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State and Utility variables
        const State = {
            db: null,
            auth: null,
            user: null,
            view: 'write', // 'write' | 'history' | 'insights' | 'dashboard'
            entries: [],
            text: '', // Text for the Write/Edit view
            isRecording: false,
            loading: false,
            aiLoading: false,
            insight: '',
            searchTerm: '',
            error: '',
            successMsg: '',
            recognition: null,
            editingEntryId: null,
            appId: typeof __app_id !== 'undefined' ? __app_id : 'micro-journal-html',
            chartInstance: null
        };

        // --- UI UTILS & HELPERS ---

        /**
         * Renders an icon from Lucide-js using an SVG string.
         * @param {string} iconName - The name of the icon (e.g., 'Calendar').
         * @param {string} classNames - Tailwind classes for styling.
         * @param {number} size - Icon size.
         * @returns {string} HTML string for the icon.
         */
        const renderIcon = (iconName, classNames = '', size = 18) => {
            // Mapping icon names to SVG paths (simplified set for common use)
            const icons = {
                Calendar: `<path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/>`,
                BookOpen: `<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>`,
                Sparkles: `<path d="m12 3-1.9 5.8a2 2 0 0 1-1.2 1.2L3 12l5.8 1.9c.7.2 1.2.7 1.4 1.4l1.9 5.8 1.9-5.8a2 2 0 0 1 1.4-1.4l5.8-1.9-5.8-1.9a2 2 0 0 1-1.2-1.2z"/>`,
                Mic: `<path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/>`,
                MicOff: `<line x1="1" x2="23" y1="1" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12"/><path d="M15 9.34V5a3 3 0 0 0-5.4-1.77"/><path d="M8.83 17.5A7 7 0 0 0 19 12v-2"/><path d="M11 19.93C11 20.65 11.64 21.2 12.5 21.2h-.02M4 14V12a7 7 0 0 1 6.18-6.91"/>`,
                Search: `<circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/>`,
                Trash2: `<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>`,
                Save: `<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>`,
                Zap: `<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>`,
                Feather: `<path d="M20.2 21c-.4.5-.6.8-.7.1L15 22l-1.4-1.4c-.7-.7-.7-2.3 0-3l4.6-4.6c.7-.7 2.3-.7 3 0L22 17l.1.7c-.7.1-1.1.4-1.6.9z"/><path d="M4 17s.7-1.2 2-2.7c3.4-3.4 10-2.4 12-4C18 6.5 15.5 3 12 5 9.5 7.5 8 13.5 8 17s-2 2.5-4 4"/>`
            };
            const svgContent = icons[iconName] || '';
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classNames}"><title>${iconName}</title>${svgContent}</svg>`;
        };

        const showMessage = (message, type = 'error') => {
            State[type === 'success' ? 'successMsg' : 'error'] = message;
            State[type === 'success' ? 'error' : 'successMsg'] = '';
            renderApp();
            // Clear message after 5 seconds
            setTimeout(() => {
                State[type === 'success' ? 'successMsg' : 'error'] = '';
                renderApp();
            }, 5000);
        };

        const formatDate = (date) => {
            return date.toLocaleDateString(undefined, { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        };
        
        const detectMood = (txt) => {
            const lower = txt.toLowerCase();
            if (['sad', 'anxious', 'tired', 'stress', 'difficult'].some(w => lower.includes(w))) return 'reflective';
            if (['happy', 'great', 'excited', 'love', 'joy', 'wonderful'].some(w => lower.includes(w))) return 'positive';
            return 'neutral';
        };

        // --- GEMINI API INTEGRATION ---

        const generateGeminiInsight = async (entriesText) => {
            const apiKey = ""; // Injected by environment
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are a compassionate, insightful therapy assistant. 
            Analyze the user's recent journal entries. 
            1. Identify the core emotional themes (e.g., "Anxiety about future", "Gratitude for small things").
            2. Spot patterns in their thinking (e.g., "You tend to catastrophicize when tired").
            3. Provide one actionable, gentle suggestion for the next week.
            4. Keep the tone warm, safe, and encouraging. 
            5. Format with bold headings and bullet points using Markdown format.`;

            const payload = {
                contents: [{ parts: [{ text: `Here are my recent journal entries:\n\n${entriesText}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                let response;
                let data;
                let retries = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) { // Too Many Requests
                            retries++;
                            const delay = initialDelay * Math.pow(2, retries - 1);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; 
                        }
                        
                        if (!response.ok) throw new Error(`Gemini API Error: ${response.status} ${response.statusText}`);

                        data = await response.json();
                        break; // Success
                    } catch (error) {
                        if (retries === maxRetries - 1 || error.message.includes("Gemini API Error")) {
                            throw error; // Re-throw if last attempt or non-retryable error
                        }
                        retries++;
                        const delay = initialDelay * Math.pow(2, retries - 1);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't generate an insight this time. The model returned an empty response.";
            } catch (error) {
                console.error("AI Error:", error);
                throw new Error("AI analysis failed due to a network or API error.");
            }
        };


        // --- FIREBASE AND INITIALIZATION ---

        const initFirebase = async () => {
            let authInstance;
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config === 'string' && __firebase_config ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                authInstance = getAuth(app);
                State.db = getFirestore(app);
                State.auth = authInstance;

                // 1. Sign In
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(authInstance, __initial_auth_token);
                } else {
                    await signInAnonymously(authInstance);
                }

                // 2. Auth Listener & Data Sync Setup
                onAuthStateChanged(authInstance, (currentUser) => {
                    State.user = currentUser;
                    renderAuthStatus();
                    if (currentUser) {
                        setupFirestoreListener(currentUser.uid);
                    } else {
                        State.entries = []; // Clear entries if user logs out (though anonymous is default)
                        renderApp();
                    }
                });

                // 3. Init Speech Recognition
                setupSpeechRecognition();

            } catch (e) {
                console.error("Firebase init error:", e);
                showMessage("Configuration error. Please reload the page.", 'error');
            }
        };

        const setupFirestoreListener = (userId) => {
            if (!State.db || !userId) return;

            const q = query(
                collection(State.db, 'artifacts', State.appId, 'users', userId, 'journal_entries'),
                orderBy('createdAt', 'desc')
            );

            // Cleanup previous listener if needed (though not strictly necessary in single-user mode)
            if (State.unsubscribe) State.unsubscribe();

            State.unsubscribe = onSnapshot(q, (snapshot) => {
                const loadedEntries = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert Firestore Timestamp to Date object
                    date: doc.data().createdAt?.toDate() || new Date()
                }));
                State.entries = loadedEntries;
                renderApp();
            }, (err) => {
                console.error("Firestore error:", err);
                showMessage("Could not sync journal entries.", 'error');
            });
        };

        const setupSpeechRecognition = () => {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognitionInstance = new SpeechRecognition();
                recognitionInstance.continuous = true;
                recognitionInstance.interimResults = true;
                
                recognitionInstance.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + ' ';
                        }
                    }
                    if (finalTranscript) {
                        State.text += finalTranscript;
                        renderApp();
                    }
                };

                recognitionInstance.onerror = (event) => {
                    console.error("Speech error", event.error);
                    State.isRecording = false;
                    showMessage("Voice recording stopped due to error or silence.", 'error');
                    renderApp();
                };

                State.recognition = recognitionInstance;
            }
        };

        // --- CORE APPLICATION LOGIC (exported as App for inline HTML calls) ---

        window.App = {
            setView: (newView) => {
                State.view = newView;
                renderApp();
            },

            handleSave: async () => {
                const textToSave = State.text.trim();
                if (!textToSave || !State.user || !State.db || State.loading) return;
                
                State.loading = true;
                renderApp();
                
                try {
                    const mood = detectMood(textToSave);
                    
                    await addDoc(collection(State.db, 'artifacts', State.appId, 'users', State.user.uid, 'journal_entries'), {
                        text: textToSave,
                        mood: mood,
                        createdAt: serverTimestamp(),
                        source: State.isRecording ? 'voice' : 'text'
                    });
                    
                    State.text = '';
                    showMessage('Entry saved securely to the cloud!', 'success');
                } catch (err) {
                    console.error("Save error:", err);
                    showMessage("Failed to save entry: " + err.message, 'error');
                } finally {
                    State.loading = false;
                    renderApp();
                }
            },

            handleDelete: async (id) => {
                // Use custom UI instead of window.confirm/alert
                if (!window.confirm('Are you sure you want to delete this memory? This cannot be undone.')) return;
                
                try {
                    await deleteDoc(doc(State.db, 'artifacts', State.appId, 'users', State.user.uid, 'journal_entries', id));
                    showMessage('Entry deleted successfully.', 'success');
                } catch (err) {
                    console.error("Delete error:", err);
                    showMessage("Failed to delete entry.", 'error');
                }
            },

            toggleRecording: () => {
                if (!State.recognition) {
                    showMessage("Speech recognition is not supported in this browser.", 'error');
                    return;
                }
                if (State.isRecording) {
                    State.recognition.stop();
                    State.isRecording = false;
                } else {
                    State.recognition.start();
                    State.isRecording = true;
                }
                renderApp();
            },

            // --- EDITING LOGIC ---
            openEditModal: (entry) => {
                State.editingEntryId = entry.id;
                document.getElementById('edit-text-area').value = entry.text;
                document.getElementById('edit-modal').classList.remove('opacity-0', 'invisible', 'scale-95');
                document.getElementById('edit-modal').classList.add('opacity-100', 'visible', 'scale-100');
            },
            
            closeEditModal: () => {
                State.editingEntryId = null;
                document.getElementById('edit-modal').classList.add('opacity-0', 'invisible', 'scale-95');
                document.getElementById('edit-modal').classList.remove('opacity-100', 'visible', 'scale-100');
            },

            handleUpdate: async () => {
                const newText = document.getElementById('edit-text-area').value.trim();
                const entryId = State.editingEntryId;

                if (!newText || !entryId || !State.user || !State.db) {
                    App.closeEditModal();
                    return;
                }

                document.getElementById('update-button').disabled = true;

                try {
                    const mood = detectMood(newText);
                    await updateDoc(doc(State.db, 'artifacts', State.appId, 'users', State.user.uid, 'journal_entries', entryId), {
                        text: newText,
                        mood: mood,
                        updatedAt: serverTimestamp()
                    });

                    App.closeEditModal();
                    showMessage('Entry updated successfully!', 'success');
                } catch (err) {
                    console.error("Update error:", err);
                    showMessage("Failed to update entry: " + err.message, 'error');
                } finally {
                    document.getElementById('update-button').disabled = false;
                }
            },


            handleGenerateInsights: async () => {
                if (State.entries.length < 1) return;
                State.aiLoading = true;
                State.insight = '';
                State.error = '';
                renderApp();
                
                try {
                    // Take last 10 entries for context
                    const recentEntriesText = State.entries.slice(0, 10).map(e => 
                        `[${formatDate(e.date)}]: ${e.text}`
                    ).join('\n\n');

                    const aiResponse = await generateGeminiInsight(recentEntriesText);
                    State.insight = aiResponse;
                } catch (err) {
                    console.error("Insight generation error:", err);
                    showMessage(err.message || "AI analysis failed. Check console for details.", 'error');
                } finally {
                    State.aiLoading = false;
                    renderApp();
                }
            }
        };

        // --- RENDERING FUNCTIONS ---

        const renderAuthStatus = () => {
            const statusEl = document.getElementById('auth-status');
            if (State.user) {
                statusEl.innerHTML = `
                    <span class="text-green-600 flex items-center gap-1 justify-end">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Cloud Sync Active
                    </span>
                    <span class="text-slate-400 text-[10px] truncate">User: ${State.user.uid}</span>
                `;
            } else {
                statusEl.innerHTML = `<span class="text-amber-600">Connecting...</span>`;
            }
        }

        const renderMessages = () => {
            const messagesEl = document.getElementById('messages');
            messagesEl.innerHTML = ''; // Clear previous messages

            if (State.error) {
                messagesEl.innerHTML += `
                    <div class="p-4 bg-red-50 text-red-700 rounded-xl text-sm border border-red-200 flex items-center gap-2">
                        ${renderIcon('Zap', '', 16)} <span class="font-semibold">Error:</span> ${State.error}
                    </div>
                `;
            }
            if (State.successMsg) {
                messagesEl.innerHTML += `
                    <div class="p-4 bg-green-50 text-green-700 rounded-xl text-sm border border-green-200 flex items-center gap-2">
                        ${renderIcon('Save', '', 16)} <span class="font-semibold">Success:</span> ${State.successMsg}
                    </div>
                `;
            }
        }

        const renderNavTabs = () => {
            const tabsEl = document.getElementById('nav-tabs');
            const tabs = [
                { id: 'write', icon: 'Calendar', label: 'Write' },
                { id: 'history', icon: 'BookOpen', label: 'History' },
                { id: 'dashboard', icon: 'Feather', label: 'Dashboard' },
                { id: 'insights', icon: 'Sparkles', label: 'Insights' }
            ];

            tabsEl.innerHTML = tabs.map(tab => {
                const isActive = State.view === tab.id;
                return `
                    <button
                        onclick="App.setView('${tab.id}')"
                        class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg text-sm font-medium transition-all duration-200 ${
                            isActive
                                ? 'bg-indigo-600 text-white shadow-md'
                                : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                        }"
                    >
                        ${renderIcon(tab.icon, '', 18)}
                        ${tab.label}
                    </button>
                `;
            }).join('');
        }

        const renderWriteView = () => {
            const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            const micIcon = State.isRecording ? 'MicOff' : 'Mic';
            const micClass = State.isRecording
                ? 'bg-red-500 text-white ring-4 ring-red-500/30 animate-pulse'
                : 'bg-white text-slate-400 hover:text-indigo-600 border border-slate-200 hover:border-indigo-300';
            const saveClass = State.text.trim().length === 0 || State.loading
                ? 'bg-slate-300 cursor-not-allowed'
                : 'bg-indigo-600 hover:bg-indigo-700 hover:shadow-xl hover:scale-[1.01]';
            
            // Set initial value for textarea
            setTimeout(() => {
                const textArea = document.getElementById('write-text-area');
                if (textArea && textArea.value !== State.text) {
                    textArea.value = State.text;
                }
            }, 0);


            return `
                <div class="animate-in fade-in duration-300">
                    <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <span class="text-sm font-medium text-slate-500">${today}</span>
                            <div class="flex gap-2">
                                <button
                                    onclick="App.toggleRecording()"
                                    class="p-2 rounded-full transition-colors shadow-md ${micClass}"
                                    title="Voice Input"
                                >
                                    ${renderIcon(micIcon, '', 18)}
                                </button>
                            </div>
                        </div>
                        
                        <textarea
                            id="write-text-area"
                            oninput="State.text = this.value; renderApp()"
                            placeholder="${State.isRecording ? "Listening... speak your thoughts..." : "How are you feeling right now? What happened today? Be honest."}"
                            class="w-full h-64 p-6 text-lg leading-relaxed resize-none focus:outline-none placeholder:text-slate-300 text-slate-700"
                        >${State.text}</textarea>
                        
                        <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                            <span class="text-xs text-slate-400 font-mono">${State.text.length} chars</span>
                            <button
                                onclick="App.handleSave()"
                                ${State.text.trim().length === 0 || State.loading ? 'disabled' : ''}
                                class="px-6 py-2.5 rounded-xl font-semibold text-white shadow-lg flex items-center gap-2 transition-all duration-300 ${saveClass}"
                            >
                                ${State.loading ? 'Saving...' : `${renderIcon('Save', '', 18)} Save Entry`}
                            </button>
                        </div>
                    </div>

                    <!-- Prompt Suggestion -->
                    ${State.text.length === 0 ? `
                        <div class="mt-6 text-center">
                            <p class="text-slate-400 text-sm mb-2">Need inspiration?</p>
                            <div class="flex justify-center flex-wrap gap-2">
                                <button 
                                    onclick="State.text='Today, I felt proud when...'; renderApp()"
                                    class="text-indigo-500 hover:text-indigo-700 text-sm font-medium hover:underline p-1"
                                >
                                    "Today, I felt proud when..."
                                </button>
                                <span class="text-slate-300">•</span>
                                <button 
                                    onclick="State.text='A challenging moment I faced was...'; renderApp()"
                                    class="text-indigo-500 hover:text-indigo-700 text-sm font-medium hover:underline p-1"
                                >
                                    "A challenging moment I faced was..."
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        };

        const renderHistoryView = () => {
            const filteredEntries = State.entries.filter(e =>
                e.text.toLowerCase().includes(State.searchTerm.toLowerCase())
            );

            // Set search input value after render
            setTimeout(() => {
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = State.searchTerm;
            }, 0);

            return `
                <div class="animate-in fade-in duration-300 space-y-4">
                    <!-- Search Bar -->
                    <div class="relative">
                        ${renderIcon('Search', 'absolute left-3 top-1/2 -translate-y-1/2 text-slate-400', 18)}
                        <input 
                            type="text" 
                            id="search-input"
                            oninput="State.searchTerm = this.value; renderApp()"
                            placeholder="Search your memories..."
                            class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm"
                        />
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">
                            ${filteredEntries.length} / ${State.entries.length} entries
                        </div>
                    </div>

                    <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        ${State.entries.length === 0 ? `
                            <div class="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-200 shadow-sm">
                                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3">
                                    ${renderIcon('BookOpen', 'text-slate-300', 24)}
                                </div>
                                <p class="text-slate-500">Your journal is empty.</p>
                                <button onclick="App.setView('write')" class="text-indigo-600 font-medium mt-2 hover:underline">Write your first entry</button>
                            </div>
                        ` : filteredEntries.length === 0 ? `
                            <p class="text-center text-slate-500 py-8">No matching entries found for "${State.searchTerm}".</p>
                        ` : filteredEntries.map(entry => {
                            const moodClass = entry.mood === 'positive' 
                                ? 'bg-emerald-100 text-emerald-700' 
                                : entry.mood === 'reflective' 
                                    ? 'bg-blue-100 text-blue-700' 
                                    : 'bg-slate-100 text-slate-600';
                            
                            return `
                                <div class="group bg-white p-5 rounded-2xl shadow-md border border-slate-200 hover:border-indigo-400 transition-all hover:shadow-lg">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                ${formatDate(entry.date)}
                                            </span>
                                            <span class="text-slate-300">•</span>
                                            <span class="text-xs px-2 py-0.5 rounded-full font-medium shadow-inner ${moodClass}">
                                                ${entry.mood}
                                            </span>
                                            ${entry.source === 'voice' ? `
                                                <span class="text-xs text-indigo-500 flex items-center gap-1">
                                                    ${renderIcon('Mic', '', 12)} Voice
                                                </span>
                                            ` : ''}
                                        </div>
                                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button 
                                                onclick="App.openEditModal(${JSON.stringify(entry).replace(/'/g, "\\'")})"
                                                class="text-slate-400 hover:text-indigo-500 p-1 -mt-1 -mr-1"
                                                title="Edit Entry"
                                            >
                                                ${renderIcon('Save', 'rotate-90', 16)} 
                                            </button>
                                            <button 
                                                onclick="App.handleDelete('${entry.id}')"
                                                class="text-slate-300 hover:text-red-500 p-1 -mt-1 -mr-1"
                                                title="Delete Entry"
                                            >
                                                ${renderIcon('Trash2', '', 16)}
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-slate-700 leading-relaxed whitespace-pre-wrap">${entry.text}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        const renderInsightsView = () => {
            const insightContent = State.insight
                .split('\n')
                .map(line => {
                    // Simple Markdown to HTML conversion for bold and lists
                    let htmlLine = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    if (htmlLine.startsWith('* ')) {
                        // Simple list item conversion
                        htmlLine = `<li class="ml-4 list-disc text-slate-700">${htmlLine.substring(2)}</li>`;
                    } else if (htmlLine.startsWith('- ')) {
                        // Simple list item conversion
                        htmlLine = `<li class="ml-4 list-disc text-slate-700">${htmlLine.substring(2)}</li>`;
                    } else if (htmlLine.trim() === '') {
                        htmlLine = `<div class="h-2"></div>`; // Add spacing for paragraphs
                    } else {
                        htmlLine = `<p class="mb-2 text-slate-700">${htmlLine}</p>`;
                    }
                    return htmlLine;
                }).join('');

            return `
                <div class="animate-in fade-in duration-300">
                    <div class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 text-white shadow-xl mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                                ${renderIcon('Sparkles', 'text-yellow-300', 24)}
                            </div>
                            <h2 class="text-xl font-bold">AI Companion</h2>
                        </div>
                        <p class="text-indigo-100 mb-6 leading-relaxed">
                            I can analyze your last 10 entries to find patterns, offer comfort, and suggest small steps forward.
                        </p>
                        <button
                            onclick="App.handleGenerateInsights()"
                            ${State.aiLoading || State.entries.length < 1 ? 'disabled' : ''}
                            class="w-full bg-white text-indigo-600 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                        >
                            ${State.aiLoading ? `
                                <span class="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></span>
                                Analyzing...
                            ` : 'Generate New Insights'}
                        </button>
                    </div>

                    ${State.insight ? `
                        <div class="bg-white rounded-2xl p-6 shadow-xl border border-slate-200">
                            <h3 class="font-bold text-lg text-slate-800 mb-4 pb-2 border-b border-slate-100">Your Personalized Analysis</h3>
                            <div class="text-slate-700 leading-relaxed">
                                ${insightContent}
                            </div>
                        </div>
                    ` : (State.entries.length > 0 && !State.aiLoading) ? `
                        <div class="text-center text-slate-400 py-8">
                            Tap the button above to reflect on your journey.
                        </div>
                    ` : `
                        <div class="text-center text-slate-400 py-8">
                            Write a few entries first to unlock AI insights.
                        </div>
                    `}
                </div>
            `;
        };
        
        const renderDashboardView = () => {
            // 1. Calculate Mood Statistics
            const moodCounts = State.entries.reduce((acc, entry) => {
                const mood = entry.mood || 'neutral';
                acc[mood] = (acc[mood] || 0) + 1;
                return acc;
            }, {});

            const moodData = [
                { mood: 'positive', label: 'Positive', count: moodCounts['positive'] || 0, color: 'bg-emerald-500', hex: '#10B981' },
                { mood: 'reflective', label: 'Reflective', count: moodCounts['reflective'] || 0, color: 'bg-blue-500', hex: '#3B82F6' },
                { mood: 'neutral', label: 'Neutral', count: moodCounts['neutral'] || 0, color: 'bg-slate-400', hex: '#94A3B8' },
            ];
            
            const totalEntries = State.entries.length;

            if (State.chartInstance) {
                State.chartInstance.destroy();
                State.chartInstance = null;
            }

            // 2. Render HTML Structure
            const html = `
                <div class="animate-in fade-in duration-300 space-y-6">
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-slate-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4 pb-2 border-b border-slate-100">Mood Tracker Summary</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            ${moodData.map(d => `
                                <div class="p-4 rounded-xl shadow-inner border border-slate-100">
                                    <div class="text-sm font-medium text-slate-500">${d.label} Entries</div>
                                    <div class="text-3xl font-extrabold text-slate-900">${d.count}</div>
                                </div>
                            `).join('')}
                        </div>

                        ${totalEntries > 0 ? `
                            <div class="w-full h-80 flex justify-center items-center">
                                <canvas id="moodChart" class="max-h-full max-w-full"></canvas>
                            </div>
                        ` : `
                            <div class="text-center py-8 text-slate-500">
                                No data yet. Write some entries to track your mood over time!
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // 3. Post-Render Chart Initialization
            // Using a timeout to ensure the canvas element is in the DOM
            if (totalEntries > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('moodChart');
                    if (ctx) {
                        State.chartInstance = new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: moodData.map(d => `${d.label} (${(d.count / totalEntries * 100).toFixed(0)}%)`),
                                datasets: [{
                                    data: moodData.map(d => d.count),
                                    backgroundColor: moodData.map(d => d.hex),
                                    hoverOffset: 8,
                                    borderWidth: 1,
                                    borderColor: '#ffffff',
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            usePointStyle: true,
                                            boxWidth: 10,
                                            padding: 20
                                        }
                                    },
                                    title: {
                                        display: false
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed !== null) {
                                                    label += new Intl.NumberFormat('en-US').format(context.parsed) + ' entries';
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                }
                            },
                        });
                    }
                }, 100);
            }
            
            return html;
        };


        const renderApp = () => {
            renderAuthStatus();
            renderMessages();
            renderNavTabs();

            const contentEl = document.getElementById('main-content');
            let contentHtml = '';

            switch (State.view) {
                case 'write':
                    contentHtml = renderWriteView();
                    break;
                case 'history':
                    contentHtml = renderHistoryView();
                    break;
                case 'dashboard':
                    contentHtml = renderDashboardView();
                    break;
                case 'insights':
                    contentHtml = renderInsightsView();
                    break;
                default:
                    contentHtml = '<div>View not found.</div>';
            }
            contentEl.innerHTML = contentHtml;
        };


        // --- ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            renderApp();
            
            // Listen for changes in the edit text area outside the main render loop
            document.getElementById('edit-text-area').addEventListener('input', (e) => {
                const button = document.getElementById('update-button');
                if (button) {
                    button.disabled = e.target.value.trim() === '';
                }
            });
        });

    </script>
</body>
</html>
